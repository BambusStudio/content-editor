<!doctype html>
<!--[if lt IE 7]>      <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Content-editor</title>
  <link rel="stylesheet" href="app/css/app.css">
  <script src="../bower_components/modernizr/modernizr.js"></script>
  <script src="../bower_components/Sortable/Sortable.js"></script>
  
</head>
<body>
<!--.editor-column*5>.column-content{1.$}+.column-remove-->
<div id="editor">

    <div class="row-add"></div>
</div>
<script>
    var editor = document.getElementById('editor');
    
    
    function createRow(){
        var row = document.createElement('div');
        var rowHandle = document.createElement('div');
        var rowAdd = document.createElement('div');
        var rowRemove = document.createElement('div');
        row.className = 'editor-row';
        rowHandle.className = 'row-handle';
        rowAdd.className = 'column-add';
        rowRemove.className ='row-remove';
        row.appendChild(rowHandle);
        row.appendChild(createCol());
        row.appendChild(rowAdd);
        row.appendChild(rowRemove);
        initColumns(row);
        return row;
    }
    
    function createCol(size){
        var col = document.createElement('div');
        var colContent = document.createElement('div');
        var colRemove = document.createElement('div');
        var colResize = document.createElement('div');
        col.className = 'editor-column';
        colContent.className = 'column-content';
        colRemove.className = 'column-remove';
        colResize.className = 'column-resize';
        colContent.innerHTML = Math.round(Math.random()*10);
        col.appendChild(colContent);
        col.appendChild(colResize);
        col.appendChild(colRemove);
        return col;
    }
    function resizeCol(){
        
    }
    function initColumns(row){
        new Sortable(row, {
            group: 'column',
            draggable: ".editor-column",  
            ghostClass: "sortable-ghost"
        });
    }
    function serialize(){
        var rows = editor.querySelectorAll('.editor-row');
        var contentSerialized = [];
        [].forEach.call(rows,function(row){
            var rowSerialized = [];
            [].forEach.call(row.querySelectorAll('.editor-column'),function(col){
                var columnSerialized = {
                    content:col.getElementsByClassName('column-content')[0].innerHTML,
                    size:window.getComputedStyle(col).width
                };
                rowSerialized.push(columnSerialized);
            });
            contentSerialized.push(rowSerialized);    
        });
        console.log(contentSerialized)
    }
    
    //  add listners
    editor.addEventListener('click',function(event){
        //add Row;
        if(event.target.classList.contains('row-add')){
            event.target.parentElement.insertBefore(createRow(),event.target);
        }
        // remove Col;
        if(event.target.classList.contains('row-remove')){
            var col = event.target.parentElement;
            col.parentElement.removeChild(col);
        }
        // add Col;
        if(event.target.classList.contains('column-add')){
            event.target.parentElement.insertBefore(createCol(),event.target)
        }
        // remove Col;
        if(event.target.classList.contains('column-remove')){
            var col = event.target.parentElement;
            col.parentElement.removeChild(col);
        }
    },false);
    //column resize
    editor.addEventListener('mousedown',function(event){
        // resize target;
        var target = event.target.parentElement;
        if(event.target.classList.contains('column-resize')){
            var startPoint = event.clientX;
            var startWidth = target.clientWidth+16;//border fix
            var resizer = function(event){
                //return with limited to inverted size of targetso it can't be scaled in negaivesize. 
                //Set step to 50px
                var additinalSize = Math.max(startWidth*-1,Math.round((event.clientX-startPoint)/50)*50);
                target.style.width = startWidth+additinalSize+'px';
                
            }
            var stopResizer = function(event){
                window.removeEventListener('mousemove',resizer,false)
                window.removeEventListener('mousemove',stopResizer,false)
            }
            window.addEventListener('mousemove',resizer,false)
            window.addEventListener('mouseup',stopResizer,false)
            event.stopImmediatePropagation();
            event.preventDefault();
        }
    },false)
    
        
    //init rows;
    new Sortable(editor, {
        group: "rows",
        handle: ".row-handle", 
        draggable: ".editor-row",
        ghostClass: "sortable-ghost"
    });
</script>
</body>
</html>